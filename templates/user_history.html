<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Transaction History</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style_main.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/style_history.css') }}"
    />
    <style>
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        padding: 10px;
        text-align: center;
        border: 1px solid #ccc;
      }
      th {
        background-color: #007bff;
        color: white;
      }
      tr.fraud {
        background-color: #f8d7da;
        color: #721c24;
      }
      tr.safe {
        background-color: #d4edda;
        color: #155724;
      }
      tr:hover {
        background-color: #e2e3e5;
      }
      .no-records {
        text-align: center;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="navbar">
        <div class="logo">PaySafe AI</div>
        <ul class="nav-links">
          <li><a href="{{ url_for('index_user') }}">Home</a></li>
          <li>
            <a href="{{ url_for('user_transaction_form') }}">Transaction</a>
          </li>
          <li>
            <a href="{{ url_for('user_history') }}" class="active">History</a>
          </li>
          <li><a href="{{ url_for('user_profile') }}">Profile</a></li>
          <li><a href="{{ url_for('index') }}">Logout</a></li>
        </ul>
      </nav>
    </header>

    <div class="container">
      <h2>Transaction History</h2>
      <table>
        <thead>
          <tr>
            <th>Amount</th>
            <th>Age</th>
            <th>Income</th>
            <th>Payment Type</th>
            <th>Device OS</th>
            <th>Session Length</th>
            <th>Result</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="historyTable">
          <tr>
            <td colspan="8" class="no-records">Loading transactions...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <script>
      async function loadHistory() {
        try {
          const res = await fetch("/api/history");
          const records = await res.json();
          const tbody = document.getElementById("historyTable");
          tbody.innerHTML = "";

          if (!records || records.length === 0) {
            tbody.innerHTML = `<tr><td colspan="8" class="no-records">No transaction history found.</td></tr>`;
            return;
          }

          tbody.innerHTML = records
            .map(
              (r) => `
          <tr class="${r.prediction === "Fraud" ? "fraud" : "safe"}">
            <td>${r.intended_balcon_amount || "-"}</td>
            <td>${r.customer_age || "-"}</td>
            <td>${r.income || "-"}</td>
            <td>${r.payment_type || "-"}</td>
            <td>${r.device_os || "-"}</td>
            <td>${r.session_length_in_minutes || "-"}</td>
            <td>${r.prediction || "-"}</td>
            <td><button onclick="deleteTransaction('${
              r._id
            }')">Delete</button></td>
          </tr>
        `
            )
            .join("");
        } catch (err) {
          console.error(err);
          document.getElementById(
            "historyTable"
          ).innerHTML = `<tr><td colspan="8" class="no-records">Failed to load transaction history.</td></tr>`;
        }
      }

      async function deleteTransaction(id) {
        if (!confirm("Are you sure you want to delete this transaction?"))
          return;
        try {
          const res = await fetch(`/api/history/${id}`, { method: "DELETE" });
          const data = await res.json();
          alert(data.message || data.error);
          loadHistory();
        } catch (err) {
          console.error(err);
          alert("Failed to delete transaction.");
        }
      }
      window.addEventListener("DOMContentLoaded", loadHistory);
    </script>
  </body>
</html>
